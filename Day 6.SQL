drop table if exists #input


-- select id = '1' , col = '.........................................#.....#..##.....................#...........................#.....................#....#.' into #input union all select id = '2' , col = '..................#................................#..#.................................#................#........................' union all select id = '3' , col = '.....##.........#..#........#......#............#.....#..................#............................#...#...#..#...#............' union all select id = '4' , col = '#..#...#....#...#.................................#.........................................#...............................#.....' union all select id = '5' , col = '.................##...................................................#.........................#....................#............' union all select id = '6' , col = '.............#.............#...................#...................#..................................#....#..#........#....#.....' union all select id = '7' , col = '..#.........................................................................................##....#.................#.............' union all select id = '8' , col = '...........#.........#.....#..#.................#...........##..........#....#....................................#........#.#....' union all select id = '9' , col = '#...#.........................................#..........................................................#........................' union all select id = '10' , col = '.............................................#................................#...............................##..........#.......' union all select id = '11' , col = '......#....#..............#..........................................#....#........................#...................##....#....' union all select id = '12' , col = '........#.#..............................#..#.............#.......#............................................................#..' union all select id = '13' , col = '....#...............#...#..#......#...........................#........................#...........#...#...................#......' union all select id = '14' , col = '..........................#...........##....#.......................................#..........................#.#................' union all select id = '15' , col = '....................#.........................................................#........#..........................................' union all select id = '16' , col = '..............#.............#.##.............#.........#..........#.......................................#...#.........#..#......' union all select id = '17' , col = '...............................................................#..........#........#.........#.............#.............#........' union all select id = '18' , col = '............#.................#...................#....#......................................................................#...' union all select id = '19' , col = '.......#....##....#......##.........#...........................................#....................................#.........#..' union all select id = '20' , col = '......#...#......................#............................##....##....................#.......................................' union all select id = '21' , col = '...................................##....................#.............................#........................#.................' union all select id = '22' , col = '..........................#.#.........................#..........................................................#................' union all select id = '23' , col = '.............#...#..........................................................#..#.#.#.....#....#.....#...................#........#' union all select id = '24' , col = '....#......#.............#...#......#.........#............##..................#.......................#..........................' union all select id = '25' , col = '.......................#.....#...................................#..........................#.....................................' union all select id = '26' , col = '#.....##....................................#.....#.....................................................#....#....................' union all select id = '27' , col = '............#...#...................................................................#.........#......................#............' union all select id = '28' , col = '................#....................................#.....#.........#.........#..............#...................................' union all select id = '29' , col = '..........................................................................................#.....#.#...#.........#.......#.........' union all select id = '30' , col = '#.............#..............................................#...#.#..#.....................#...#............#.#...#..............' union all select id = '31' , col = '..........................................#..................................................................#...#................' union all select id = '32' , col = '.........#.............................................#................................#.................#.....#................#' union all select id = '33' , col = '........................................................................................#.......#.....#..........#..........#.....' union all select id = '34' , col = '...........................#.......#......#..........#............#...............#........#...#......#...........................' union all select id = '35' , col = '...##...................#.................................#..................................##...................................' union all select id = '36' , col = '........................................................#.#.#.....#............................##................#................' union all select id = '37' , col = '......................................#....................#..................#...#.............................#...........#.....' union all select id = '38' , col = '.............................#...#.................#.............................#..............#.................................' union all select id = '39' , col = '#.....................................................................................................................#..#.....#..' union all select id = '40' , col = '...........................#..............................................#................................#....................#.' union all select id = '41' , col = '......#..................##................#....................#.............................................................#..#' union all select id = '42' , col = '.................#....................................................................................#...........................' union all select id = '43' , col = '....#.#..................................#..#........................##...#.............................#..............#..........' union all select id = '44' , col = '...............................................................................................................#...#.....#........' union all select id = '45' , col = '..#...................#.......................#........................................................................#..........' union all select id = '46' , col = '..#............#......................................###.........#..............................#..........#.................#...' union all select id = '47' , col = '.................................#..........................................................................#............#........' union all select id = '48' , col = '......................#...#...............#..............................#.......#........................#...........#........#..' union all select id = '49' , col = '..#..................#............................................................................#......#........................' union all select id = '50' , col = '..........................................................................#....#........#...................#.............#.......' union all select id = '51' , col = '..............#.........#.#............................................................................................#..........' union all select id = '52' , col = '........................#...#............................................#..............................#.........................' union all select id = '53' , col = '.........................................#...................................................#........................#...........' union all select id = '54' , col = '...#.................................................#..........#.............................#.....#.#.........#.................' union all select id = '55' , col = '............................#...........#...............................................................#........................#' union all select id = '56' , col = '..........................#..#..................#....................................#..................#.......................#.' union all select id = '57' , col = '......#...................#..............................#........#.##..........................................................#.' union all select id = '58' , col = '...........................#.....#.............................................................................#..................' union all select id = '59' , col = '..............#........................................................#.#.......#...#................#....#......................' union all select id = '60' , col = '...#...#..........................................................................................................................' union all select id = '61' , col = '..........##.....................#.#.............#...............................#.........................................#......' union all select id = '62' , col = '.#.#...................#.................................#.................................................#....#.................' union all select id = '63' , col = '........................#..............................................................................................#.......#..' union all select id = '64' , col = '...#....................................................................................................#.....##.....#............' union all select id = '65' , col = '.............#........................#.....................................................#.............#....................#.#' union all select id = '66' , col = '#........................................................................................#.....#..................................' union all select id = '67' , col = '........#..............#...............................#.......#...................................#..........#...................' union all select id = '68' , col = '.....................#.........................#.......#.......#.....#...........................................................#' union all select id = '69' , col = '...............#.....................................................................#..........#.................................' union all select id = '70' , col = '.................................#....#..........#..............................#...........#............................#........' union all select id = '71' , col = '..............#......#.........#...#.............#.......................#....#...................................................' union all select id = '72' , col = '...........................................................^.......................................................#..............' union all select id = '73' , col = '..........#...............................#.........................#.....................................................#.....#.' union all select id = '74' , col = '.##.....................#....................#.....#.......................................................#..##...#..........#...' union all select id = '75' , col = '.......................#...........#..#.#.....................................................#....................#..............' union all select id = '76' , col = '..................................................................#......#.............#..................................#.......' union all select id = '77' , col = '.#............................................#........................#...................................#.........#............' union all select id = '78' , col = '..................................................................................#.##.........................#..................' union all select id = '79' , col = '................#........#...........................................#...................................#........................' union all select id = '80' , col = '...............#........#....#...................#................................#........#.....#..........#.................#...' union all select id = '81' , col = '.....#.............................#..........................................................................................#...' union all select id = '82' , col = '............#..............#.....#........................................#............#............##..........#.................' union all select id = '83' , col = '........................................................................................#..........................#........##....' union all select id = '84' , col = '..#............................#...#.................................#....#..............#........................................' union all select id = '85' , col = '...#.....................#...........................................................................#.....................#......' union all select id = '86' , col = '....#.........................#.............#..................................#.........#..............#.........................' union all select id = '87' , col = '.....................#...................................................................................#..#......#..............' union all select id = '88' , col = '.....#.................................#...............................#.....#..........#.........................................' union all select id = '89' , col = '............#........#..........#....................#....................#..#.#.....................................#............' union all select id = '90' , col = '........................................#......#......................#......................................#..#.......#.........' union all select id = '91' , col = '...#...........#...............#.................#.............................................#..........#...#...................' union all select id = '92' , col = '.......#....##..............................#......#.......................#..................#..........#.................#...#..' union all select id = '93' , col = '.................................##...........................................................#....#..........#.#........#........' union all select id = '94' , col = '..................................#....##..#..#.......#............................#............#.#........................#......' union all select id = '95' , col = '..........................................#.....................................#.............##...#............#.................' union all select id = '96' , col = '....#....................#................................#....#..#.....................#................#...#..#..#..............' union all select id = '97' , col = '.............#...#..............................................................................#.................................' union all select id = '98' , col = '..........#..........................#.......................................#....................#..#.......#.........#.....#....' union all select id = '99' , col = '......................#............#...............#.....#.................#...............................#...#....#.........##..' union all select id = '100' , col = '..........................................................................##.............................#...#..............#.....' union all select id = '101' , col = '#.#...#..................................................#..................................#..#...#..............................' union all select id = '102' , col = '...........................................#....#..............#.........................#........................................' union all select id = '103' , col = '...........#....................#.....................##........................#.....#...................................#....#..' union all select id = '104' , col = '..........#..........#.................................................#...............................................#..........' union all select id = '105' , col = '.....................................................................................#......#.....................#.#.............' union all select id = '106' , col = '........#.#..........................#...............................................................................#............' union all select id = '107' , col = '..............#..#.............#...........#......................#....#..#......#...................#............................' union all select id = '108' , col = '........#.......#.................#........#..........#.....................#.........................................#...........' union all select id = '109' , col = '..........................................................#...................................#.....#.........#......#...#........' union all select id = '110' , col = '..........#.....#.....................#............#............#.#......................#....#.##.............#...........#......' union all select id = '111' , col = '...#.#..#.......#......#........#...........................#....................#.....#.........#...........#.................#..' union all select id = '112' , col = '........#.......................................#............#.............#..................#......#......#...............#.#...' union all select id = '113' , col = '....................#.....#........#.........................#.................................................#................#.' union all select id = '114' , col = '.......#..#...........................................#......#..................#..#......................#..#....................' union all select id = '115' , col = '#.#........#....#...#.............................................#............................#.....................#............' union all select id = '116' , col = '#...................#...........#...................#..#................................................................#.#.......' union all select id = '117' , col = '............#...#.#...........#..#.....................................................................#........................#.' union all select id = '118' , col = '...#..............................................#..............#......#...#..............................................#......' union all select id = '119' , col = '................#...#..#..................................................................................................##...#..' union all select id = '120' , col = '.............................#...#..#........#.........#...#...................#............................................#.....' union all select id = '121' , col = '............#......................#.......................................................#.#....................................' union all select id = '122' , col = '...#......................#......#.#...........................................#.....#....#......................#...#............' union all select id = '123' , col = '.....#..#..........#.............................#..........................................#............#..................#.....' union all select id = '124' , col = '.................#...#.......................#..................................................#....................#............' union all select id = '125' , col = '............#..................................................#.....#..............#.......#.............................#.#....#' union all select id = '126' , col = '........#.............#..#.......................................................................................#.........#......' union all select id = '127' , col = '......#...................#..........................................................#................#................#.........#' union all select id = '128' , col = '..................#...........................#.....#....#.......................................#..#......................#......' union all select id = '129' , col = '....................#....................................#....................#........#............#........#....#...............' union all select id = '130' , col = '.........#..............#....#.............................#..#..........#........#.....................#.#.........#.............'  

select r = '1' , col = '....#.....' into #input union all select id = '2' , col = '....^....#' union all select id = '3' , col = '..........' union all select id = '4' , col = '..#.......' union all select id = '5' , col = '.......#..' union all select id = '6' , col = '..........' union all select id = '7' , col = '.#........' union all select id = '8' , col = '........#.' union all select id = '9' , col = '#.........' union all select id = '10' , col = '......#...' 


drop table if exists #brk 

; with cte as 
(select r = cast(r as int), c = 1 , curr= left(col, 1), rem = right(col, len(col) - 1) from #input
 union all 
 select r = cast(r as int), c + 1 , curr= left(rem, 1), rem = right(rem, len(rem) - 1) from cte 
 where rem != ''
) 
select * into #brk  from cte
option (maxrecursion 0)


alter table #brk drop COLUMN rem 

; with cte as 
(
select r, c, curr, dir = 'U'  from #brk where curr = '^'
    union all 
select 
 map.r, map.c, case when prev.dir = 'U' then 'R'
                     when prev.dir = 'R' then 'D'
                     when prev.dir = 'D' then 'L'
                     when prev.dir = 'L' then 'U'  
                end
from cte prev inner join #brk map
on 1 = case when prev.dir = 'U' and map.c = prev.c and map.r < prev.r then 1
            when prev.dir = 'R' and map.c > prev.c and map.r = prev.r then 1
            when prev.dir = 'D' and map.c = prev.c and map.r > prev.r then 1
            when prev.dir = 'L' and map.c < prev.c and map.r = prev.r then 1
       end



) 


select * from cte