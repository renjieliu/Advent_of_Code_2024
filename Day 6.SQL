drop table if exists #input


-- idea
-- for each point on the map, to get the nearest # location in 4 directions, and get the distance between them
-- for the ones to go outside the map, the distance is null 

-- select id = '1' , col = '....#.....' into #input union all select id = '2' , col = '.........#' union all select id = '3' , col = '..........' union all select id = '4' , col = '..#.......' union all select id = '5' , col = '.......#..' union all select id = '6' , col = '..........' union all select id = '7' , col = '.#..^.....' union all select id = '8' , col = '........#.' union all select id = '9' , col = '#.........' union all select id = '10' , col = '......#...' 

select id = '1' , col = '.........................................#.....#..##.....................#...........................#.....................#....#.' into #input union all select id = '2' , col = '..................#................................#..#.................................#................#........................' union all select id = '3' , col = '.....##.........#..#........#......#............#.....#..................#............................#...#...#..#...#............' union all select id = '4' , col = '#..#...#....#...#.................................#.........................................#...............................#.....' union all select id = '5' , col = '.................##...................................................#.........................#....................#............' union all select id = '6' , col = '.............#.............#...................#...................#..................................#....#..#........#....#.....' union all select id = '7' , col = '..#.........................................................................................##....#.................#.............' union all select id = '8' , col = '...........#.........#.....#..#.................#...........##..........#....#....................................#........#.#....' union all select id = '9' , col = '#...#.........................................#..........................................................#........................' union all select id = '10' , col = '.............................................#................................#...............................##..........#.......' union all select id = '11' , col = '......#....#..............#..........................................#....#........................#...................##....#....' union all select id = '12' , col = '........#.#..............................#..#.............#.......#............................................................#..' union all select id = '13' , col = '....#...............#...#..#......#...........................#........................#...........#...#...................#......' union all select id = '14' , col = '..........................#...........##....#.......................................#..........................#.#................' union all select id = '15' , col = '....................#.........................................................#........#..........................................' union all select id = '16' , col = '..............#.............#.##.............#.........#..........#.......................................#...#.........#..#......' union all select id = '17' , col = '...............................................................#..........#........#.........#.............#.............#........' union all select id = '18' , col = '............#.................#...................#....#......................................................................#...' union all select id = '19' , col = '.......#....##....#......##.........#...........................................#....................................#.........#..' union all select id = '20' , col = '......#...#......................#............................##....##....................#.......................................' union all select id = '21' , col = '...................................##....................#.............................#........................#.................' union all select id = '22' , col = '..........................#.#.........................#..........................................................#................' union all select id = '23' , col = '.............#...#..........................................................#..#.#.#.....#....#.....#...................#........#' union all select id = '24' , col = '....#......#.............#...#......#.........#............##..................#.......................#..........................' union all select id = '25' , col = '.......................#.....#...................................#..........................#.....................................' union all select id = '26' , col = '#.....##....................................#.....#.....................................................#....#....................' union all select id = '27' , col = '............#...#...................................................................#.........#......................#............' union all select id = '28' , col = '................#....................................#.....#.........#.........#..............#...................................' union all select id = '29' , col = '..........................................................................................#.....#.#...#.........#.......#.........' union all select id = '30' , col = '#.............#..............................................#...#.#..#.....................#...#............#.#...#..............' union all select id = '31' , col = '..........................................#..................................................................#...#................' union all select id = '32' , col = '.........#.............................................#................................#.................#.....#................#' union all select id = '33' , col = '........................................................................................#.......#.....#..........#..........#.....' union all select id = '34' , col = '...........................#.......#......#..........#............#...............#........#...#......#...........................' union all select id = '35' , col = '...##...................#.................................#..................................##...................................' union all select id = '36' , col = '........................................................#.#.#.....#............................##................#................' union all select id = '37' , col = '......................................#....................#..................#...#.............................#...........#.....' union all select id = '38' , col = '.............................#...#.................#.............................#..............#.................................' union all select id = '39' , col = '#.....................................................................................................................#..#.....#..' union all select id = '40' , col = '...........................#..............................................#................................#....................#.' union all select id = '41' , col = '......#..................##................#....................#.............................................................#..#' union all select id = '42' , col = '.................#....................................................................................#...........................' union all select id = '43' , col = '....#.#..................................#..#........................##...#.............................#..............#..........' union all select id = '44' , col = '...............................................................................................................#...#.....#........' union all select id = '45' , col = '..#...................#.......................#........................................................................#..........' union all select id = '46' , col = '..#............#......................................###.........#..............................#..........#.................#...' union all select id = '47' , col = '.................................#..........................................................................#............#........' union all select id = '48' , col = '......................#...#...............#..............................#.......#........................#...........#........#..' union all select id = '49' , col = '..#..................#............................................................................#......#........................' union all select id = '50' , col = '..........................................................................#....#........#...................#.............#.......' union all select id = '51' , col = '..............#.........#.#............................................................................................#..........' union all select id = '52' , col = '........................#...#............................................#..............................#.........................' union all select id = '53' , col = '.........................................#...................................................#........................#...........' union all select id = '54' , col = '...#.................................................#..........#.............................#.....#.#.........#.................' union all select id = '55' , col = '............................#...........#...............................................................#........................#' union all select id = '56' , col = '..........................#..#..................#....................................#..................#.......................#.' union all select id = '57' , col = '......#...................#..............................#........#.##..........................................................#.' union all select id = '58' , col = '...........................#.....#.............................................................................#..................' union all select id = '59' , col = '..............#........................................................#.#.......#...#................#....#......................' union all select id = '60' , col = '...#...#..........................................................................................................................' union all select id = '61' , col = '..........##.....................#.#.............#...............................#.........................................#......' union all select id = '62' , col = '.#.#...................#.................................#.................................................#....#.................' union all select id = '63' , col = '........................#..............................................................................................#.......#..' union all select id = '64' , col = '...#....................................................................................................#.....##.....#............' union all select id = '65' , col = '.............#........................#.....................................................#.............#....................#.#' union all select id = '66' , col = '#........................................................................................#.....#..................................' union all select id = '67' , col = '........#..............#...............................#.......#...................................#..........#...................' union all select id = '68' , col = '.....................#.........................#.......#.......#.....#...........................................................#' union all select id = '69' , col = '...............#.....................................................................#..........#.................................' union all select id = '70' , col = '.................................#....#..........#..............................#...........#............................#........' union all select id = '71' , col = '..............#......#.........#...#.............#.......................#....#...................................................' union all select id = '72' , col = '...........................................................^.......................................................#..............' union all select id = '73' , col = '..........#...............................#.........................#.....................................................#.....#.' union all select id = '74' , col = '.##.....................#....................#.....#.......................................................#..##...#..........#...' union all select id = '75' , col = '.......................#...........#..#.#.....................................................#....................#..............' union all select id = '76' , col = '..................................................................#......#.............#..................................#.......' union all select id = '77' , col = '.#............................................#........................#...................................#.........#............' union all select id = '78' , col = '..................................................................................#.##.........................#..................' union all select id = '79' , col = '................#........#...........................................#...................................#........................' union all select id = '80' , col = '...............#........#....#...................#................................#........#.....#..........#.................#...' union all select id = '81' , col = '.....#.............................#..........................................................................................#...' union all select id = '82' , col = '............#..............#.....#........................................#............#............##..........#.................' union all select id = '83' , col = '........................................................................................#..........................#........##....' union all select id = '84' , col = '..#............................#...#.................................#....#..............#........................................' union all select id = '85' , col = '...#.....................#...........................................................................#.....................#......' union all select id = '86' , col = '....#.........................#.............#..................................#.........#..............#.........................' union all select id = '87' , col = '.....................#...................................................................................#..#......#..............' union all select id = '88' , col = '.....#.................................#...............................#.....#..........#.........................................' union all select id = '89' , col = '............#........#..........#....................#....................#..#.#.....................................#............' union all select id = '90' , col = '........................................#......#......................#......................................#..#.......#.........' union all select id = '91' , col = '...#...........#...............#.................#.............................................#..........#...#...................' union all select id = '92' , col = '.......#....##..............................#......#.......................#..................#..........#.................#...#..' union all select id = '93' , col = '.................................##...........................................................#....#..........#.#........#........' union all select id = '94' , col = '..................................#....##..#..#.......#............................#............#.#........................#......' union all select id = '95' , col = '..........................................#.....................................#.............##...#............#.................' union all select id = '96' , col = '....#....................#................................#....#..#.....................#................#...#..#..#..............' union all select id = '97' , col = '.............#...#..............................................................................#.................................' union all select id = '98' , col = '..........#..........................#.......................................#....................#..#.......#.........#.....#....' union all select id = '99' , col = '......................#............#...............#.....#.................#...............................#...#....#.........##..' union all select id = '100' , col = '..........................................................................##.............................#...#..............#.....' union all select id = '101' , col = '#.#...#..................................................#..................................#..#...#..............................' union all select id = '102' , col = '...........................................#....#..............#.........................#........................................' union all select id = '103' , col = '...........#....................#.....................##........................#.....#...................................#....#..' union all select id = '104' , col = '..........#..........#.................................................#...............................................#..........' union all select id = '105' , col = '.....................................................................................#......#.....................#.#.............' union all select id = '106' , col = '........#.#..........................#...............................................................................#............' union all select id = '107' , col = '..............#..#.............#...........#......................#....#..#......#...................#............................' union all select id = '108' , col = '........#.......#.................#........#..........#.....................#.........................................#...........' union all select id = '109' , col = '..........................................................#...................................#.....#.........#......#...#........' union all select id = '110' , col = '..........#.....#.....................#............#............#.#......................#....#.##.............#...........#......' union all select id = '111' , col = '...#.#..#.......#......#........#...........................#....................#.....#.........#...........#.................#..' union all select id = '112' , col = '........#.......................................#............#.............#..................#......#......#...............#.#...' union all select id = '113' , col = '....................#.....#........#.........................#.................................................#................#.' union all select id = '114' , col = '.......#..#...........................................#......#..................#..#......................#..#....................' union all select id = '115' , col = '#.#........#....#...#.............................................#............................#.....................#............' union all select id = '116' , col = '#...................#...........#...................#..#................................................................#.#.......' union all select id = '117' , col = '............#...#.#...........#..#.....................................................................#........................#.' union all select id = '118' , col = '...#..............................................#..............#......#...#..............................................#......' union all select id = '119' , col = '................#...#..#..................................................................................................##...#..' union all select id = '120' , col = '.............................#...#..#........#.........#...#...................#............................................#.....' union all select id = '121' , col = '............#......................#.......................................................#.#....................................' union all select id = '122' , col = '...#......................#......#.#...........................................#.....#....#......................#...#............' union all select id = '123' , col = '.....#..#..........#.............................#..........................................#............#..................#.....' union all select id = '124' , col = '.................#...#.......................#..................................................#....................#............' union all select id = '125' , col = '............#..................................................#.....#..............#.......#.............................#.#....#' union all select id = '126' , col = '........#.............#..#.......................................................................................#.........#......' union all select id = '127' , col = '......#...................#..........................................................#................#................#.........#' union all select id = '128' , col = '..................#...........................#.....#....#.......................................#..#......................#......' union all select id = '129' , col = '....................#....................................#....................#........#............#........#....#...............' union all select id = '130' , col = '.........#..............#....#.............................#..#..........#........#.....................#.#.........#.............'  

drop table if exists #brk 

; with cte as 
(select point_id = 1,  r = cast(id as int), c = 1 , ch= left(col, 1), rem = right(col, len(col) - 1) from #input
 union all 
 select point_id + 1 , r , c + 1 , ch= left(rem, 1), rem = right(rem, len(rem) - 1) from cte 
 where rem != ''
) 
select * into #brk  from cte
option (maxrecursion 0)


drop table if exists #nxt

select og.*
, up_r = up.r
-- , up_c = up.c
, down_r = down.r
-- , down_c = down.c
-- , left_r = lft.r
, left_c = lft.c 
-- , right_r = rit.r
, right_c = rit.c 
into #nxt
  from #brk og 
left outer join #brk up on og.c = up.c and up.r <= og.r and up.ch = '#' 
    and not exists (select * from #brk up2 where og.c = up2.c and up2.r <= og.r and up2.ch = '#' and up2.r>up.r)
left outer join #brk down on og.c = down.c and down.r >= og.r and down.ch = '#' 
    and not exists (select * from #brk down2 where og.c = down2.c and down2.r >= og.r and down2.ch = '#' and down2.r < down.r)
left outer join #brk lft on og.c >= lft.c and lft.r = og.r and lft.ch = '#' 
    and not exists (select * from #brk lft2 where og.c >= lft2.c and lft2.r = og.r and lft2.ch = '#' and lft2.c > lft.c)
left outer join #brk rit on og.c <= rit.c and rit.r = og.r and rit.ch = '#' 
    and not exists (select * from #brk rit2 where og.c <= rit2.c and rit2.r = og.r and rit2.ch = '#' and rit2.c < rit.c)


-- select count(*) from #brk 
-- select count(*) from #nxt 

-- select * from #nxt 

drop table if exists #walk

-- alter table #brk drop COLUMN rem 

; with cte as 
(
select id = 1,  step = 0,  r, c,  dir = 'U'  from #brk where ch = '^'
union all 
select 
id + 1
, step + 
   case when curr.dir = 'U' then abs(nxt.up_r + 1 - curr.r)
        when curr.dir = 'D' then abs(nxt.down_r - 1 - curr.r)
        when curr.dir = 'L' then abs(nxt.left_c + 1 - curr.c)
        when curr.dir = 'R' then abs(nxt.right_c - 1 - curr.c) 
       end 
,  r =  case when curr.dir = 'U' then nxt.up_r + 1  
             when curr.dir = 'D' then nxt.down_r -1  
             when curr.dir = 'L' then curr.r  
             when curr.dir = 'R' then curr.r  
        end
,  c = case when curr.dir = 'U' then curr.c 
        when curr.dir = 'D' then curr.c 
        when curr.dir = 'L' then nxt.left_c + 1 
        when curr.dir = 'R' then nxt.right_c - 1 
        end

, dir = case when curr.dir = 'U' then 'R'
            when curr.dir = 'D' then 'L'
            when curr.dir = 'L' then 'U'
            when curr.dir = 'R' then 'D'
        end

from cte curr inner join #nxt nxt 
on curr.r= nxt.r and curr.c = nxt.c
where case  when curr.dir = 'U' then up_r
            when curr.dir = 'D' then down_r 
            when curr.dir = 'L' then left_c
            when curr.dir = 'R' then right_c
       end is not null 
) 
-- adding the final point on the map before exiting 
select *  into #walk
 from cte
option (maxrecursion 0 )


-- select * from #walk 

drop table if exists #curr_next

select
id 
, curr_r = r
, curr_c = c 
, next_r = case when lead(r, 1) over (order by id) is null 
                then case when dir = 'U' then 1
                          when dir = 'D' then (select max(r) from #brk )
                          when dir in ('R', 'L') then r
                     end
                else
                lead(r, 1) over (order by id)
           end 
, next_c = case when lead(c, 1) over (order by id) is null 
                then case when dir in ('U', 'D') then c
                          when dir = 'R' then (select max(c) from #brk)
                          when dir = 'L' then 1
                     end
                else
                lead(c, 1) over (order by id)
           end 
into #curr_next
from #walk 


-- select * from #curr_next


-- 4883
select res = count(*) 
from 
(
    select distinct map.r, map.c  from #curr_next cn inner join #brk map 
    on 
    (map.c between cn.curr_c and cn.next_c or map.c between cn.next_c and curr_c)
    and 
    (map.r between cn.curr_r and cn.next_r or map.r between cn.next_r and curr_r)
) t

-- Q2 










-- create table day06 as 
-- select   1 row_num ,  '....#.....' input union all
-- select   2 , '.........#' union all
-- select   3 , '..........' union all
-- select   4 , '..#.......' union all
-- select   5 , '.......#..' union all
-- select   6 , '..........' union all
-- select   7 , '.#..^.....' union all
-- select   8 , '........#.' union all
-- select   9 , '#.........' union all
-- select   10 , '......#...' 

-- ; 

--  with recursive map as (
--     select array_agg(replace(input, '^', '.')) as og,
--         max(length(input)) as max_j,
--         max(row_num) as max_i,
--         max(case when input like '%^%' then row_num end) as start_i,
--         max(position('^' in input)) as start_j
--     from day06
-- )
-- , obstacles as (
--     select oi, oj
--     from map
--     cross join generate_series(1, max_i) as oi
--     cross join generate_series(1, max_j) as oj
--     where oi != start_i or oj != start_j
--     union all
--     select -1, -1
-- ) 
-- -- select * from obstacles 
-- ,
-- cte as (
--     select 0 as t, oi, oj, start_i as i, start_j as j, -1 as di, 0 as dj
--     from map, obstacles 
    
--     union all
    
--     select t + 1, oi, oj, 
--         case when nxt = '.' then next_i else i end,
--         case when nxt = '.' then next_j else j end,
--         case when nxt = '.' then di when nxt = '#' then dj end,
--         case when nxt = '.' then dj when nxt = '#' then -di end
--     from map, cte
--     , lateral (
--         select i + di as next_i
--              , j + dj as next_j
--              , case
--               when not (i + di between 1 and max_i)
--                   or not (j + dj between 1 and max_j) then null
--               when i + di = oi and j + dj = oj then '#'
--                 else substring(map.og[i + di], j + dj, 1)
--             end as nxt
--       ) as new_pos
--     where t < max_i * max_j  -- just to stop the loop
--           and new_pos.nxt is not null -- not stepping out
-- )

-- select * from cte 
-- where (oi, oj) = (1, 5)
-- -- where i = 7 and j = 5 
-- -- order by t , oi, oj 

-- -- , part1 as (
-- --     select count(distinct (i,j))
-- --     from steps
-- --     where (oi, oj) = (-1, -1)
-- -- ), part2 as (
-- --     select count(distinct (oi, oj))
-- --     from steps, map
-- --     where t = max_i * max_j
-- -- )
-- -- select * from part1, part2;







-- create table day06 as 
-- select   1 row_num ,  '....#.....' input union all
-- select   2 , '.........#' union all
-- select   3 , '..........' union all
-- select   4 , '..#.......' union all
-- select   5 , '.......#..' union all
-- select   6 , '..........' union all
-- select   7 , '.#..^.....' union all
-- select   8 , '........#.' union all
-- select   9 , '#.........' union all
-- select   10 , '......#...' 

-- ; 

--  with recursive map as (
--     select array_agg(replace(input, '^', '.')) as map,
--         max(length(input)) as max_j,
--         max(row_num) as max_i,
--         max(case when input like '%^%' then row_num end) as start_i,
--         max(position('^' in input)) as start_j
--     from day06
-- )
-- , obstacles as (
--     select oi, oj
--     from map
--     cross join generate_series(1, max_i) as oi
--     cross join generate_series(1, max_j) as oj
--     where oi != start_i or oj != start_j
--     union all
--     select -1, -1
-- )
-- -- select * from obstacles 
-- ,
-- steps as (
--     select 0 as t, oi, oj, start_i as i, start_j as j, -1 as di, 0 as dj
--     from map, obstacles
--     union all
--     select t + 1, oi, oj,
--         case when next_tile = '.' then next_i else i end,
--         case when next_tile = '.' then next_j else j end,
--         case when next_tile = '.' then di else dj end,
--         case when next_tile = '.' then dj else -di end
--     from steps, map, lateral (
--         select i + di as next_i, j + dj as next_j, case
--             when not (i + di between 1 and max_i)
--                 or not (j + dj between 1 and max_j)  then null
--             when i + di = oi and j + dj = oj then 'O'
--             else substring(map.map[i + di], j + dj, 1)
--         end as next_tile
--     ) as new_pos
--     where t < max_i * max_j and new_pos.next_tile is not null
-- )

-- select * from steps 

-- -- , part1 as (
-- --     select count(distinct (i,j))
-- --     from steps
-- --     where (oi, oj) = (-1, -1)
-- -- ), part2 as (
-- --     select count(distinct (oi, oj))
-- --     from steps, map
-- --     where t = max_i * max_j
-- -- )
-- -- select * from part1, part2;